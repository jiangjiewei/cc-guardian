# -*-  encoding:utf-8  -*-
import numpy as np
import matplotlib.pyplot as plt
import os

caffe_root = '/home/jie/caffe/caffe-master/'
import sys
sys.path.insert(0,caffe_root+'python')

import caffe

MODEL_FILE = caffe_root+'myself/python_okornotok/okornotok_result/deploy.prototxt'
PRETRAINED = caffe_root+'myself/python_okornotok/okornotok_result/caffe_alexnet_train_iter_50.caffemodel'

#TEST_FILE = '../data/liris-accede/test_arousal.txt'
MEAN_FILE = caffe_root+'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.binaryproto'



# Open mean.binaryproto file

#blob = caffe.proto.caffe_pb2.BlobProto()
#data = open(MEAN_FILE , 'rb').read()
#blob.ParseFromString(data)
#mean_arr = caffe.io.blobproto_to_array(blob)

#mean123 = mean_arr[0]
#mean1234 = mean_arr[0].mean(1).mean(1)

# Initialize NN
# Initialize NN
net = caffe.Classifier(MODEL_FILE, PRETRAINED,
                       image_dims=(256,256),
                       mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy').mean(1).mean(1),
                      # mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy').mean(1).mean(1),
                       #mean(1).mean(1),
                       input_scale=255,
                       raw_scale=255,
                       channel_swap=(2,1,0)
                        )

net.blobs['data'].reshape(1,3,227,227)
test_file1 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/other-5/test"
test_file2 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/ok-5/test"
test_file3 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/ok"
sum=0
error_number=0
for root,dirs,files in os.walk(test_file1):
	for file in files:
		#print file
		IMAGE_FILE = os.path.join(root,file)
		prediction = net.predict([caffe.io.load_image(IMAGE_FILE)]) #prediction = net.predict([caffe.io.load_image(IMAGE_FILE)],oversample=False)
		print 'predicted class:',prediction[0].argmax()
		if prediction[0].argmax() == 1:
			error_number = error_number+1
		#print("Predicted class probe argmax is #{}.".format(out['prob'].argmax()))

print sum
print error_number



        	#print 'prediction shape:',prediction[0].shape
		#plt.plot(prediction[0])
		#print "predicted class:%s"%(IMAGE_FILE)
		#input_image = caffe.io.load_image(IMAGE_FILE)
		#print input_image
		#prediction class


#caffe.set_mode_gpu()
#caffe.set_phase_test()

# input preprocessing: 'data' is the name of the input blob == net.inputs[0]
#net.set_mean('data', mean_arr[0]) # ImageNet mean
#net.set_raw_scale('data', 255)  # the reference model operates on images in [0,255] range instead of [0,1]
#net.set_channel_swap('data', (2,1,0))  # the reference model has channels in BGR order instead of RGB



#caffe.set_mode_cpu()

#net = caffe.Net(MODEL_FILE,
#                PRETRAINED,
#                caffe.TEST)

# input preprocessing: 'data' is the name of the input blob == net.inputs[0]
#transformer = caffe.io.Transformer({'data': net.blobs['data'].data.shape})
#transformer.set_transpose('data', (2,0,1))
#net.set_mean('data',mean_arr[0])

#transformer.set_mean('data', mean_arr[0]) # mean pixel

#transformer.set_mean('data', np.load(caffe_root + 'myself/python_okornotok/okornotok_result/ilsvrc_mean.npy').mean(1).mean(1)) # mean pixel
#transformer.set_mean('data', np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mean.npy').mean(1).mean(1)) # mean pixel

#mean_file = np.array([72,65,60])
#transformer.set_mean('data', mean_file)

#transformer.set_raw_scale('data', 255)  # the reference model operates on images in [0,255] range instead of [0,1]
#transformer.set_channel_swap('data', (2,1,0))  # the reference model has channels in BGR order instead of RGB









net = caffe.Classifier(MODEL_FILE, PRETRAINED)


net = caffe.Classifier(MODEL_FILE, PRETRAINED,
                       mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy'),
                      # mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy').mean(1).mean(1),
                       #mean(1).mean(1),

                       channel_swap=(2,1,0),
                       raw_scale=255,

                       #input_scale=255,

                       image_dims=(256,256)
                        )

#net.set_phase_test()
#net.set_mode_cpu()


# input preprocessing: 'data' is the name of the input blob == net.inputs[0]
net.set_mean('data', mean_arr[0]) # ImageNet mean
#net.set_raw_scale('data', 255)  # the reference model operates on images in [0,255] range instead of [0,1]
net.set_channel_swap('data', (2,1,0))  # the reference model has channels in BGR order instead of RGB




test_file1 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/other-5/test"
test_file2 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/ok-5/test"
test_file3 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/ok"
for root,dirs,files in os.walk(test_file2):
	for file in files:
		#print file
		IMAGE_FILE = os.path.join(root,file)
		prediction = net.predict([caffe.io.load_image(IMAGE_FILE)]) #prediction = net.predict([caffe.io.load_image(IMAGE_FILE)],oversample=False)
		print 'predicted class:',prediction[0].argmax()
		#print 'prediction shape:',prediction[0].shape
		#plt.plot(prediction[0])
		#print "predicted class:%s"%(IMAGE_FILE)
		#input_image = caffe.io.load_image(IMAGE_FILE)
		#print input_image
		#prediction class





# Load test file
Inputs = ['...'] # list of paths
GroundTruths = ['...'] # list of groud truths
Predictions = []

# Compute predictions
for idx in range(len(Inputs)):
 im = caffe.io.load_image_uint(Inputs[idx])
 prediction = net.predict([im], False) # predict takes any number of images, and formats them for the Caffe net automatically
                                      # average predictions across center, corners, and mirrors when True (default). Center-only prediction when False.
 Predictions.append(prediction[0][0])





#Initial the network
net = caffe.Classifier(MODEL_FILE, PRETRAINED,
                       #mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy'))
                      # mean=np.load(caffe_root + 'myself/python_okornotok/okornotok_result/mnist_train_lmdb_mean.npy').mean(1).mean(1),
                       #mean(1).mean(1),

                       channel_swap=(2,1,0),
                       raw_scale=255,

                       #input_scale=255,

                       image_dims=(256,256)
                        )
               #oversample=False,

#imagenet_labels_filename = caffe_root + 'data/ilsvrc12/synset_words.txt'
#labels = np.loadtxt(imagenet_labels_filename, str, delimiter='\t')

input_image = caffe.io.load_image(caffe_root + "myself/python_okornotok/okornotok/train/ok/20150919-13720-147955.jpg" )

prediction = net.predict([input_image])
print 'predicted class:',prediction[0].argmax()

plt.rcParams['figure.figsize'] = (10, 10)
plt.rcParams['image.interpolation'] = 'nearest'
plt.rcParams['image.cmap'] = 'gray'
plt.imshow(input_image)



#net.blobs['data'].reshape(1,3,227,227)


test_file1 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/other-5/test"
test_file2 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok5-5/ok-5/test"
test_file3 = "/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/ok"
for root,dirs,files in os.walk(test_file2):
	for file in files:
		#print file
		IMAGE_FILE = os.path.join(root,file)
		prediction = net.predict([caffe.io.load_image(IMAGE_FILE)]) #prediction = net.predict([caffe.io.load_image(IMAGE_FILE)],oversample=False)
		print 'predicted class:',prediction[0].argmax()
		#print 'prediction shape:',prediction[0].shape
		#plt.plot(prediction[0])
		#print "predicted class:%s"%(IMAGE_FILE)
		#input_image = caffe.io.load_image(IMAGE_FILE)
		#print input_image
		#prediction class
	
	
        #prediction = net.predict([input_image])
        #print 'predicted class:',prediction[0].argmax()
	
















prtest_dir='/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/other'
import os
for root,dirs,files in os.walk(test_dir):
	print root
	print dirs
	print files

net.blobs['data'].reshape(1,3,227,227)
test_dir='/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/other'
import os
for root,dirs,files in os.walk(test_dir):
    for i in xrange (0,files.__len__()):
        sf=os.path.join(root,files[i])
	input_image = caffe.io.load_image(sf)
        print (files[i])
 	prediction = net.predict([input_image])
        print 'predicted class:',prediction[0].argmax()
        #net.blobs['data'].data[...] = transformer.preprocess('data', caffe.io.load_image(sf))
        #out = net.forward()
        #print("Predicted class is #{}.".format(out['prob'].argmax()))


#classification
for root,dirs,files in os.walk("/home/jie/caffe/caffe-master/myself/python_okornotok/okornotok/train/ok"):
    for file in files:
        #Load the image
        IMAGE_FILE = os.path.join(root,file)
        input_image = caffe.io.load_image(IMAGE_FILE)
        
        #prediction class
        prediction = net.predict([input_image])
        print 'predicted class:',prediction[0].argmax()

        # Top 5 class
        top_k = net.blobs['prob'].data[0].flatten().argsort()[-1:-6:-1]
        print labels[top_k]
